{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "Ваш профиль" %}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{% blocktranslate %}Личный кабинет, {{ client.first_name }}{% endblocktranslate %}</h1>
    <a href="{% url 'portal:profile_edit' %}" class="btn btn-primary">{% translate "Редактировать профиль" %}</a>
  </div>

  <div class="card mb-4">
    <div class="card-header"><h5>{% translate "Ваши данные" %}</h5></div>
    <div class="card-body">
      <p><strong>Email:</strong> {{ client.email }}</p>
      <p><strong>{% translate "Телефон" %}:</strong> {{ client.phone }}</p>
      <p><strong>{% translate "Статус вашего дела" %}:</strong> <span class="badge bg-primary">{{ client.get_status_display }}</span></p>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h5>{% translate "Список документов" %}</h5></div>
    <div class="card-body">
      {% if document_status_list %}
        <p>{% translate "Ниже представлен ваш персональный список документов для загрузки." %}</p>
        <div class="accordion" id="documentAccordion">
          {% include 'portal/partials/document_checklist_content.html' with document_status_list=document_status_list %}
        </div>
      {% else %}
        <div class="alert alert-info mb-0">
          <h4 class="alert-heading">{% translate "Список документов пока не доступен" %}</h4>
          <p class="mb-0">{% translate "Ваш персональный чеклист появится здесь после подтверждения от нашего сотрудника." %}</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}


{% block extra_js %}
  {{ js_messages|json_script:"js-messages" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const accordion = document.getElementById('documentAccordion');

    const JS_MESSAGES = document.getElementById('js-messages');
    const parsedMessages = JS_MESSAGES ? JSON.parse(JS_MESSAGES.textContent) : {};
    const UPLOADED_STATUS = parsedMessages.uploaded_status || 'Загружено';
    const LOADING_MESSAGE = parsedMessages.pending_verification_status ? `${parsedMessages.pending_verification_status}...` : 'Загрузка...';

    const escapeSelector = (value) => {
        if (window.CSS && CSS.escape) {
            return CSS.escape(value);
        }
        return value.replace(/[\s"'\\:#.\[\],>~+*=]/g, '\\$&');
    };

    const buildUrl = (url) => {
        if (!url) {
            return url;
        }
        try {
            return new URL(url, window.location.origin).toString();
        } catch (error) {
            console.error('Не удалось разобрать URL', url, error);
            return url;
        }
    };

    function showFeedback(docCode, message, level = 'info') {
        if (!accordion || !docCode) {
            return;
        }
        const feedback = accordion.querySelector(`.upload-feedback[data-doc-code="${escapeSelector(docCode)}"]`);
        if (!feedback) {
            return;
        }
        feedback.classList.remove('text-success', 'text-danger', 'text-warning', 'text-muted');
        if (level === 'success') {
            feedback.classList.add('text-success');
        } else if (level === 'error') {
            feedback.classList.add('text-danger');
        } else {
            feedback.classList.add('text-muted');
        }
        feedback.textContent = message;
    }

    function setUploadingState(button, isUploading) {
        if (!button) {
            return;
        }
        const spinner = button.querySelector('.spinner-border');
        const textSpan = button.querySelector('.button-text');
        if (spinner) {
            spinner.classList.toggle('d-none', !isUploading);
        }
        if (textSpan) {
            textSpan.classList.toggle('opacity-75', isUploading);
        }
        button.disabled = isUploading;
    }

    function formatErrors(errors) {
        if (!errors) {
            return '';
        }
        try {
            if (Array.isArray(errors)) {
                return errors.join(' ');
            }
            return Object.values(errors).flat().join(' ');
        } catch (err) {
            return typeof errors === 'string' ? errors : '';
        }
    }

    if (accordion) {
        const partialUrl = buildUrl("{% url 'portal:document_checklist_partial' %}");

        const restoreExpandedPanels = (previouslyExpandedIds) => {
            previouslyExpandedIds.forEach(id => {
                const collapseEl = accordion.querySelector(`#${id}`);
                if (collapseEl) {
                    const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                    collapseInstance.show();
                    const triggerButton = accordion.querySelector(`[data-bs-target="#${id}"]`);
                    if (triggerButton) {
                        triggerButton.classList.remove('collapsed');
                        triggerButton.setAttribute('aria-expanded', 'true');
                    }
                }
            });
        };

        let isRefreshing = false;

        const refreshChecklistFromServer = (force = false) => {
            if (!partialUrl || isRefreshing) {
                return;
            }

            if (!force) {
                const hasPendingUpload = Array.from(accordion.querySelectorAll('.upload-form input[type="file"]')).some(input => input.files && input.files.length > 0);
                if (hasPendingUpload) {
                    return;
                }
            }

            isRefreshing = true;
            const expandedPanels = Array.from(accordion.querySelectorAll('.accordion-collapse.show')).map(panel => panel.id);

            fetch(partialUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                cache: 'no-store'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' && typeof data.html === 'string') {
                        const tempWrapper = document.createElement('div');
                        tempWrapper.innerHTML = data.html.trim();
                        accordion.innerHTML = tempWrapper.innerHTML;
                        restoreExpandedPanels(expandedPanels);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при обновлении списка документов:', error);
                })
                .finally(() => {
                    isRefreshing = false;
                });
        };

        accordion.addEventListener('submit', function(e) {
            const form = e.target.closest('.upload-form');
            if (!form) {
                return;
            }
            e.preventDefault();

            const formData = new FormData(form);
            const docCode = form.dataset.docCode || form.action.split('/').filter(Boolean).pop();
            const submitButton = form.querySelector('button[type="submit"]');

            const resolvedAction = buildUrl(form.action);

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrftoken) {
                headers['X-CSRFToken'] = csrftoken;
            }

            setUploadingState(submitButton, true);
            showFeedback(docCode, LOADING_MESSAGE, 'info');

            fetch(resolvedAction, {
                method: 'POST',
                headers,
                body: formData,
                credentials: 'same-origin',
                cache: 'no-store'
            })
                .then(response => {
                    const contentType = response.headers.get('Content-Type') || '';
                    if (!response.ok) {
                        if (contentType.includes('application/json')) {
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.text().then(text => Promise.reject({ status: 'error', message: text }));
                    }

                    if (contentType.includes('application/json')) {
                        return response.json();
                    }

                    return response.text().then(text => ({ status: 'html', body: text }));
                })
                .then(data => {
                    if (data.status === 'success') {
                        const docList = document.getElementById(`doc-list-${docCode}`);
                        const badge = document.getElementById(`badge-${docCode}`);

                        let currentCount = 0;
                        if (docList) {
                            const noDocsMessageEl = docList.querySelector('.no-docs-message');
                            if (noDocsMessageEl) {
                                noDocsMessageEl.remove();
                            }

                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.html;

                            Array.from(tempDiv.children).forEach(child => {
                                if (child.tagName === 'LI') {
                                    docList.appendChild(child);
                                }
                            });
                            currentCount = docList.querySelectorAll('li[data-doc-id]').length;
                        }

                        if (badge) {
                            if (currentCount === 0) {
                                badge.textContent = UPLOADED_STATUS;
                            } else {
                                badge.textContent = `${UPLOADED_STATUS} (${currentCount})`;
                            }
                            badge.className = 'badge bg-success ms-3';
                        }
                        form.reset();
                        showFeedback(docCode, data.message || (parsedMessages.uploaded_status || 'Документ успешно загружен!'), 'success');
                        refreshChecklistFromServer(true);
                    } else if (data.status === 'html') {
                        window.location.reload();
                    } else {
                        const message = data.message || formatErrors(data.errors) || 'Ошибка загрузки документа.';
                        showFeedback(docCode, message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке файла:', error);
                    const message = error?.message || formatErrors(error?.errors) || 'Произошла ошибка при загрузке файла.';
                    showFeedback(docCode, message, 'error');
                })
                .finally(() => {
                    setUploadingState(submitButton, false);
                });
        });

        refreshChecklistFromServer();
        setInterval(() => refreshChecklistFromServer(), 8000);
    }
});
</script>
{% endblock %}