{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "Ваш профиль" %}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{% blocktranslate %}Личный кабинет, {{ client.first_name }}{% endblocktranslate %}</h1>
    <a href="{% url 'portal:profile_edit' %}" class="btn btn-primary">{% translate "Редактировать профиль" %}</a>
  </div>

  <div class="card mb-4">
    <div class="card-header"><h5>{% translate "Ваши данные" %}</h5></div>
    <div class="card-body">
      <p><strong>Email:</strong> {{ client.email }}</p>
      <p><strong>{% translate "Телефон" %}:</strong> {{ client.phone }}</p>
      <p><strong>{% translate "Статус вашего дела" %}:</strong> <span class="badge bg-primary">{{ client.get_status_display }}</span></p>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h5>{% translate "Список документов" %}</h5></div>
    <div class="card-body">
      {% if document_status_list %}
        <p>{% translate "Ниже представлен ваш персональный список документов для загрузки." %}</p>
        <div class="accordion" id="documentAccordion">
          {% include 'portal/partials/document_checklist_content.html' with document_status_list=document_status_list %}
        </div>
      {% else %}
        <div class="alert alert-info mb-0">
          <h4 class="alert-heading">{% translate "Список документов пока не доступен" %}</h4>
          <p class="mb-0">{% translate "Ваш персональный чеклист появится здесь после подтверждения от нашего сотрудника." %}</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}


{% block extra_js %}
  {{ js_messages|json_script:"js-messages" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const accordion = document.getElementById('documentAccordion');

    function buildUrl(url) {
        if (!url) {
            return url;
        }
        try {
            return new URL(url, window.location.origin).toString();
        } catch (error) {
            console.error('Не удалось разобрать URL', url, error);
            return url;
        }
    }

    const JS_MESSAGES = document.getElementById('js-messages');
    const parsedMessages = JS_MESSAGES ? JSON.parse(JS_MESSAGES.textContent) : {};
    const UPLOADED_STATUS = parsedMessages.uploaded_status || 'Загружено';

    if (accordion) {
        accordion.addEventListener('submit', function(e) {
            if (e.target.classList.contains('upload-form')) {
                e.preventDefault();

                const form = e.target;
                const formData = new FormData(form);
                const docCode = form.action.split('/').filter(Boolean).pop();

                const resolvedAction = buildUrl(form.action);

                // Отправляем запрос по безопасно собранному URL
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest'
                };
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }

                fetch(resolvedAction, {
                    method: 'POST',
                    headers,
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const docList = document.getElementById(`doc-list-${docCode}`);
                        const badge = document.getElementById(`badge-${docCode}`);

                        let currentCount = 0;
                        if (docList) {
                            const noDocsMessageEl = docList.querySelector('.no-docs-message');
                            if (noDocsMessageEl) noDocsMessageEl.remove();

                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.html;

                            Array.from(tempDiv.children).forEach(child => {
                                if (child.tagName === 'LI') {
                                    docList.appendChild(child);
                                }
                            });
                            currentCount = docList.querySelectorAll('li[data-doc-id]').length;
                        }

                        if (badge) {
                            if (currentCount === 0) {
                                badge.textContent = UPLOADED_STATUS;
                            } else {
                                badge.textContent = `${UPLOADED_STATUS} (${currentCount})`;
                            }
                            badge.className = 'badge bg-success ms-3';
                        }
                        form.reset();
                        alert(data.message || 'Документ успешно загружен!');
                        refreshChecklistFromServer();
                    } else {
                        alert('Ошибка загрузки документа: ' + (data.message || JSON.stringify(data.errors)));
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке файла:', error);
                    alert('Произошла ошибка при загрузке файла.');
                });
            }
        });

        const partialUrl = buildUrl("{% url 'portal:document_checklist_partial' %}");

        function restoreExpandedPanels(previouslyExpandedIds) {
            previouslyExpandedIds.forEach(id => {
                const collapseEl = accordion.querySelector(`#${id}`);
                if (collapseEl) {
                    const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                    collapseInstance.show();
                    const triggerButton = accordion.querySelector(`[data-bs-target="#${id}"]`);
                    if (triggerButton) {
                        triggerButton.classList.remove('collapsed');
                        triggerButton.setAttribute('aria-expanded', 'true');
                    }
                }
            });
        }

        let isRefreshing = false;

        function refreshChecklistFromServer() {
            if (!partialUrl || isRefreshing) {
                return;
            }

            const hasPendingUpload = Array.from(accordion.querySelectorAll('.upload-form input[type="file"]')).some(input => input.files && input.files.length > 0);
            if (hasPendingUpload) {
                return;
            }

            isRefreshing = true;
            const expandedPanels = Array.from(accordion.querySelectorAll('.accordion-collapse.show')).map(panel => panel.id);

            fetch(partialUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success' && typeof data.html === 'string') {
                    const tempWrapper = document.createElement('div');
                    tempWrapper.innerHTML = data.html.trim();
                    accordion.innerHTML = tempWrapper.innerHTML;
                    restoreExpandedPanels(expandedPanels);
                }
            })
            .catch(error => {
                console.error('Ошибка при обновлении списка документов:', error);
            })
            .finally(() => {
                isRefreshing = false;
            });
        }

        refreshChecklistFromServer();
        setInterval(refreshChecklistFromServer, 8000);
    }
});
</script>
{% endblock %}