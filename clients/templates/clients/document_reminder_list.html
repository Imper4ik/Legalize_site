{# clients/templates/clients/document_reminder_list.html #}
{% extends "base.html" %}
{% load static i18n %}

{% block title %}
  {{ title|default:_("Напоминания") }}
{% endblock %}

{% block page_header %}
<div class="section-header">
  <div>
    <h1 class="h3 mb-1">
      <i class="fas fa-bell me-2 text-warning"></i>
      {{ title|default:_("Напоминания") }}
    </h1>
    <div class="text-muted">
      {% translate "Проверь и сгенерируй актуальные напоминания, отфильтруй по клиенту и периодам" %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <form action="{% url 'clients:run_update_reminders' %}" method="post" class="d-inline">
      {% csrf_token %}
      <input type="hidden" name="next" value="documents">
      <button type="submit" class="btn btn-gradient">
        <i class="fas fa-sync-alt me-2"></i>{% translate "Проверить и создать новые" %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block content %}

<style>
  /* Карточка фильтров с лёгким стеклянным эффектом */
  .filters-card {
    border-radius: 16px;
    border: 1px solid var(--glass-border);
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    box-shadow: var(--shadow-1);
  }

  /* Заголовок секции */
  .reminders-title {
    display: flex; align-items: center; gap: .5rem;
    margin-bottom: 1rem;
  }

  /* list-group — лучшая читаемость в тёмной теме */
  html[data-theme="dark"] .list-group-item {
    background-color: var(--surface);
    color: var(--fg);
    border-color: var(--border);
  }
  .list-group-item + .list-group-item {
    border-top-color: var(--border);
  }
  .list-group-item:hover {
    background-color: rgba(96,165,250,0.08);
  }

  /* Плашки-счётчики */
  .count-badge {
    font-weight: 600;
    padding: .25rem .5rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.5);
  }
  html[data-theme="dark"] .count-badge {
    background: rgba(255,255,255,.06);
  }

  /* Кнопки фильтров */
  .btn-soft {
    background: rgba(13,110,253,.08);
    color: #0d6efd;
    border: 1px solid rgba(13,110,253,.15);
  }

  /* Сетка фильтров компактнее на мобильном */
  @media (max-width: 768px) {
    .filters-card .row > [class^="col-"] { margin-bottom: .5rem; }
  }
</style>

{# Секция: Напоминания по документам #}
<section id="documents-section" class="reminders-section">
  <div class="reminders-title">
    <i class="fas fa-file-alt text-info"></i>
    <h4 class="mb-0">
      {% translate "Напоминания по документам" %}
      <span class="count-badge">{{ reminders_count }}</span>
    </h4>
  </div>

  <div class="card filters-card card-body mb-4">
    <form method="get" action="#documents-section" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="doc_client" class="form-label"><strong>{% translate "Клиент" %}</strong></label>
        <select name="doc_client" id="doc_client" class="form-select">
          <option value="">{% translate "Все клиенты" %}</option>
          {% for client in all_clients %}
            <option value="{{ client.id }}" {% if client_filter_id == client.id %}selected{% endif %}>{{ client }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label for="doc_start_date" class="form-label"><strong>{% translate "Дата от" %}</strong></label>
        <input type="date"
               name="doc_start_date"
               id="doc_start_date"
               class="form-control"
               value="{{ filter_values.doc_start_date|default:'' }}">
      </div>

      <div class="col-md-3">
        <label for="doc_end_date" class="form-label"><strong>{% translate "Дата до" %}</strong></label>
        <input type="date"
               name="doc_end_date"
               id="doc_end_date"
               class="form-control"
               value="{{ filter_values.doc_end_date|default:'' }}">
      </div>

      <div class="col-md-2 d-flex flex-column">
        <button type="submit" class="btn btn-soft w-100">
          <i class="bi bi-funnel me-1"></i>{% translate "Фильтровать" %}
        </button>
        <a href="{% url 'clients:document_reminder_list' %}#documents-section" class="btn btn-outline-secondary w-100 mt-2">
          {% translate "Сбросить" %}
        </a>
      </div>
    </form>
  </div>

  {% if total_reminders_count %}
    <div class="mb-3">
      <span class="text-muted">
        {% translate "Всего напоминаний" %}: <strong>{{ total_reminders_count }}</strong>
      </span>
    </div>
  {% endif %}

  <div class="accordion" id="document-reminders-accordion">
    {% for group in grouped_reminders %}
      <div class="accordion-item mb-2">
        <h2 class="accordion-header" id="heading-{{ group.client.id }}">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ group.client.id }}"
                  aria-expanded="false"
                  aria-controls="collapse-{{ group.client.id }}">
            <div class="d-flex flex-wrap align-items-center gap-2 w-100">
              <span class="fw-semibold">{{ group.client }}</span>
              <span class="badge bg-info text-dark">
                {% blocktrans with count=group.reminders|length %}Истекающих: {{ count }}{% endblocktrans %}
              </span>
              <span class="badge bg-secondary">
                {% blocktrans with count=group.missing_documents|length %}Недостающих: {{ count }}{% endblocktrans %}
              </span>
            </div>
          </button>
        </h2>
        <div id="collapse-{{ group.client.id }}"
             class="accordion-collapse collapse"
             aria-labelledby="heading-{{ group.client.id }}"
             data-bs-parent="#document-reminders-accordion">
          <div class="accordion-body">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'clients:client_detail' group.client.id %}">
                {% translate "Открыть клиента" %}
              </a>
              <form action="{% url 'clients:send_document_reminder_email' group.client.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}#heading-{{ group.client.id }}">
                <button type="submit" class="btn btn-sm btn-primary">
                  <i class="fas fa-envelope me-1"></i>{% translate "Отправить письмо" %}
                </button>
              </form>
            </div>

            <div class="mb-3">
              <h6 class="text-uppercase text-muted mb-2">{% translate "Недостающие документы" %}</h6>
              {% if group.missing_documents %}
                <ul class="list-group list-group-flush">
                  {% for doc in group.missing_documents %}
                    <li class="list-group-item d-flex justify-content-between">
                      <span>{{ doc.name }}</span>
                      {% if doc.expiry_date %}
                        <small class="text-muted">
                          {% blocktrans with due=doc.expiry_date|date:"d.m.Y" %}Последнее истечение: {{ due }}{% endblocktrans %}
                        </small>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">{% translate "Нет недостающих документов." %}</p>
              {% endif %}
            </div>

            <div>
              <h6 class="text-uppercase text-muted mb-2">{% translate "Истекающие документы" %}</h6>
              <div class="list-group">
                {% for reminder in group.reminders %}
                  {% include 'clients/partials/reminder_item.html' with reminder=reminder icon='fa-file-alt' show_client=False show_email=False %}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted mb-0">{% translate "Нет напоминаний по документам, соответствующих фильтрам." %}</p>
    {% endfor %}
  </div>
</section>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    // Если захочешь flatpickr для более приятного выбора дат — раскомментируй блок ниже.
    // document.addEventListener('DOMContentLoaded', function () {
    //   if (window.flatpickr) {
    //     flatpickr('#doc_start_date', { dateFormat: 'Y-m-d' });
    //     flatpickr('#doc_end_date',   { dateFormat: 'Y-m-d' });
    //   }
    // });
    document.addEventListener('DOMContentLoaded', function () {
      var hash = window.location.hash;
      if (!hash || !hash.startsWith('#heading-')) {
        return;
      }
      var headingElement = document.querySelector(hash);
      if (!headingElement || !window.bootstrap || !window.bootstrap.Collapse) {
        return;
      }
      var toggleButton = headingElement.querySelector('[data-bs-toggle="collapse"]');
      if (!toggleButton) {
        return;
      }
      var targetSelector = toggleButton.getAttribute('data-bs-target');
      var collapseElement = targetSelector ? document.querySelector(targetSelector) : null;
      if (!collapseElement) {
        return;
      }
      var collapse = new window.bootstrap.Collapse(collapseElement, { toggle: false });
      collapse.show();
    });
  </script>
{% endblock %}
