{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with client_name=client.first_name %}Детали клиента: {{ client_name }}{% endblocktrans %}{% endblock %}

{% block content %}
  <div id="client-overview" data-refresh-url="{% url 'clients:client_overview_partial' client.pk %}">
    {% include 'clients/partials/client_overview.html' with client=client %}
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{% translate "Финансы" %}</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">+ {% translate "Добавить счёт" %}</button>
  </div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush" id="payment-list-container">
          {% for payment in client.payments.all %}
              <li class="list-group-item" data-payment-id="{{ payment.id }}">
                  {% include 'clients/partials/payment_item.html' with payment=payment %}
              </li>
          {% empty %}
              <li class="list-group-item text-muted" id="no-payments-message">{% translate "Счета на оплату еще не созданы." %}</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <h2>{% translate "Чеклист документов" %}</h2>
  <div class="accordion" id="documentAccordion" data-refresh-url="{% url 'clients:client_checklist_partial' client.pk %}">
      {% include 'clients/partials/document_checklist.html' with document_status_list=document_status_list client=client %}
  </div>

  {% include 'clients/partials/modals.html' %}

{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- AJAX для автоматического заполнения цены в модальном окне "Добавить счёт" ---
        const addPaymentModal = document.getElementById('addPaymentModal');
        if (addPaymentModal) {
            const serviceSelect = addPaymentModal.querySelector('#id_service_description'); // Находим select внутри модального окна
            const priceInput = addPaymentModal.querySelector('#id_total_amount');       // Находим input внутри модального окна

            if (serviceSelect && priceInput) {
                serviceSelect.addEventListener('change', function() {
                    const serviceValue = this.value;
                    if (!serviceValue) {
                        priceInput.value = '0.00';
                        return;
                    }

                    // Отправляем запрос на сервер по правильному URL
                    fetch(`/staff/api/get-price/${serviceValue}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.price !== undefined) {
                                priceInput.value = data.price.toFixed(2);
                            } else {
                                priceInput.value = '0.00';
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при получении цены:', error);
                            priceInput.value = '0.00';
                        });
                });
            }
        }

        // --- Здесь ваш остальной JavaScript (например, для удаления документов) ---
        const mainContent = document.querySelector('main') || document.body;

        function getCookie(name) {
            // ... (ваш код для getCookie) ...
        }
        const csrftoken = getCookie('csrftoken');

        function updateChecklist() {
            // ... (ваш код для updateChecklist) ...
        }

        mainContent.addEventListener('submit', function(e) {
            // ... (ваш код для обработки форм) ...
        });
    });
  </script>
    
   <script>
    document.addEventListener('DOMContentLoaded', function () {
        // ... код для AJAX-цен из Шага 1 ...

        // --- JavaScript для редактирования платежа ---
        const editPaymentModal = document.getElementById('editPaymentModal');
        if (editPaymentModal) {
            editPaymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const formAction = button.getAttribute('data-form-action');
                const form = editPaymentModal.querySelector('#editPaymentForm');
                form.setAttribute('action', formAction);
            });
        }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const accordion = document.getElementById('documentAccordion');
        if (!accordion) {
            return;
        }

        function buildUrl(url) {
            if (!url) {
                return url;
            }
            try {
                return new URL(url, window.location.origin).toString();
            } catch (error) {
                console.error('Не удалось разобрать URL', url, error);
                return url;
            }
        }

        const refreshUrl = buildUrl(accordion.dataset.refreshUrl);
        if (!refreshUrl) {
            return;
        }

        function restoreExpandedPanels(previouslyExpandedIds) {
            previouslyExpandedIds.forEach(id => {
                const collapseEl = accordion.querySelector(`#${id}`);
                if (collapseEl) {
                    const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                    collapseInstance.show();
                    const triggerButton = accordion.querySelector(`[data-bs-target="#${id}"]`);
                    if (triggerButton) {
                        triggerButton.classList.remove('collapsed');
                        triggerButton.setAttribute('aria-expanded', 'true');
                    }
                }
            });
        }

        let isFetching = false;

        async function refreshChecklist() {
            if (isFetching) {
                return;
            }
            if (document.body.classList.contains('modal-open')) {
                return;
            }
            isFetching = true;
            const expandedPanels = Array.from(accordion.querySelectorAll('.accordion-collapse.show')).map(panel => panel.id);

            try {
                const response = await fetch(refreshUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const html = await response.text();
                const tempWrapper = document.createElement('div');
                tempWrapper.innerHTML = html.trim();
                accordion.innerHTML = tempWrapper.innerHTML;
                restoreExpandedPanels(expandedPanels);
            } catch (error) {
                console.error('Ошибка при обновлении чеклиста клиента:', error);
            } finally {
                isFetching = false;
            }
        }

        refreshChecklist();
        setInterval(refreshChecklist, 8000);
    });
  </script>
{% endblock %}
