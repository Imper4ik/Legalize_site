{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktranslate with client_name=client.first_name %}–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞: {{ client_name }}{% endblocktranslate %}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <div>
        <a href="{% url 'clients:client_print' pk=client.pk %}" class="btn btn-secondary me-2">{% translate "–ü–µ—á–∞—Ç—å" %}</a>
        <a href="{% url 'clients:client_edit' client.pk %}" class="btn btn-primary">{% translate "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ" %}</a>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-body">
        <p><strong>{% translate "–ù–æ–º–µ—Ä –¥–µ–ª–∞" %}:</strong> <span class="fs-5 text-primary"><strong>{{ client.case_number|default:_("–ù–µ —É–∫–∞–∑–∞–Ω") }}</strong></span></p>
        <p><strong>Email:</strong> {{ client.email }}</p>
        <p><strong>{% translate "–¢–µ–ª–µ—Ñ–æ–Ω" %}:</strong> {{ client.phone }}</p>
        <p><strong>{% translate "–¶–µ–ª—å –ø–æ–¥–∞—á–∏" %}:</strong> {{ client.get_application_purpose_display }}</p>
        <p><strong>{% translate "–û—Å–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è" %}:</strong> {{ client.basis_of_stay|default:_("–ù–µ —É–∫–∞–∑–∞–Ω–æ") }}</p>
        {% if client.legal_basis_end_date %}
            <p><strong>{% translate "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∏—è" %}:</strong> <span class="fw-bold">{{ client.legal_basis_end_date|date:"d.m.Y" }}</span></p>
        {% endif %}
    </div>
  </div>

  <div class="card border-primary mb-4 shadow">
    <div class="card-header bg-primary text-white"><h5 class="mb-0">üîë {% translate "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫–ª–∏–µ–Ω—Ç–∞" %}</h5></div>
    <div class="card-body text-center" id="access-management-container">
        {% include 'clients/partials/access_management_block.html' with client=client %}
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{% translate "–§–∏–Ω–∞–Ω—Å—ã" %}</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">+ {% translate "–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç" %}</button>
  </div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush" id="payment-list-container">
          {% for payment in client.payments.all %}
              <li class="list-group-item" data-payment-id="{{ payment.id }}">
                  {% include 'clients/partials/payment_item.html' with payment=payment %}
              </li>
          {% empty %}
              <li class="list-group-item text-muted" id="no-payments-message">{% translate "–°—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã." %}</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <h2>{% translate "–ß–µ–∫–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" %}</h2>
  <div class="accordion" id="documentAccordion">
      {% include 'clients/partials/document_checklist.html' with document_status_list=document_status_list client=client %}
  </div>

  {% include 'clients/partials/modals.html' %}

{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- AJAX –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ "–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç" ---
        const addPaymentModal = document.getElementById('addPaymentModal');
        if (addPaymentModal) {
            const serviceSelect = addPaymentModal.querySelector('#id_service_description'); // –ù–∞—Ö–æ–¥–∏–º select –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const priceInput = addPaymentModal.querySelector('#id_total_amount');       // –ù–∞—Ö–æ–¥–∏–º input –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

            if (serviceSelect && priceInput) {
                serviceSelect.addEventListener('change', function() {
                    const serviceValue = this.value;
                    if (!serviceValue) {
                        priceInput.value = '0.00';
                        return;
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É URL
                    fetch(`/staff/api/get-price/${serviceValue}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.price !== undefined) {
                                priceInput.value = data.price.toFixed(2);
                            } else {
                                priceInput.value = '0.00';
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω—ã:', error);
                            priceInput.value = '0.00';
                        });
                });
            }
        }

        // --- –ó–¥–µ—Å—å –≤–∞—à –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤) ---
        const mainContent = document.querySelector('main') || document.body;

        function getCookie(name) {
            // ... (–≤–∞—à –∫–æ–¥ –¥–ª—è getCookie) ...
        }
        const csrftoken = getCookie('csrftoken');

        function updateChecklist() {
            // ... (–≤–∞—à –∫–æ–¥ –¥–ª—è updateChecklist) ...
        }

        mainContent.addEventListener('submit', function(e) {
            // ... (–≤–∞—à –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º) ...
        });
    });
  </script>
    
   <script>
    document.addEventListener('DOMContentLoaded', function () {
        // ... –∫–æ–¥ –¥–ª—è AJAX-—Ü–µ–Ω –∏–∑ –®–∞–≥–∞ 1 ...

        // --- JavaScript –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ ---
        const editPaymentModal = document.getElementById('editPaymentModal');
        if (editPaymentModal) {
            editPaymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const formAction = button.getAttribute('data-form-action');
                const form = editPaymentModal.querySelector('#editPaymentForm');
                form.setAttribute('action', formAction);
            });
        }
    });
  </script>  
{% endblock %}