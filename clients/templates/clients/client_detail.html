{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% blocktrans with client_name=client.first_name %}Детали клиента: {{ client_name }}{% endblocktrans %}{% endblock %}

{% block content %}
  <div id="client-overview" data-refresh-url="{% url 'clients:client_overview_partial' client.pk %}">
    {% include 'clients/partials/client_overview.html' with client=client %}
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{% translate "Финансы" %}</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">+ {% translate "Добавить счёт" %}</button>
  </div>
  <div id="payment-alerts" class="mb-2"></div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush" id="payment-list-container">
          {% for payment in client.payments.all %}
              <li class="list-group-item" data-payment-id="{{ payment.id }}">
                  {% include 'clients/partials/payment_item.html' with payment=payment %}
              </li>
          {% empty %}
              <li class="list-group-item text-muted" id="no-payments-message">{% translate "Счета на оплату еще не созданы." %}</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-0">{% translate "Чеклист документов" %}</h2>
    <form
      id="verify-all-documents-form"
      action="{% url 'clients:verify_all_documents' client_id=client.pk %}"
      method="post"
      class="ms-3"
    >
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-success btn-sm">{% translate "Проверить все загруженные" %}</button>
    </form>
  </div>

  <div id="document-alerts" class="mb-2"></div>

  <div class="accordion" id="documentAccordion" data-refresh-url="{% url 'clients:client_checklist_partial' client.pk %}">
      {% include 'clients/partials/document_checklist.html' with document_status_list=document_status_list client=client %}
  </div>
{% endblock %}


{% block modals %}
  {{ block.super }}
  
  {% include 'clients/partials/modals.html' %}

  <div class="modal fade" 
       id="uploadDocumentModal" 
       tabindex="-1" 
       aria-labelledby="uploadDocumentModalLabel" 
       aria-hidden="true"
       data-action-template="{% url 'clients:add_document' client_id=client.id doc_type='__doc_type__' %}">
       
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadDocumentModalLabel">{% translate "Загрузка документа" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-body">
            <p id="uploadDocumentDescription" class="fw-bold text-primary mb-3"></p>

            <div class="mb-3">
              <label for="id_file" class="form-label">{% translate "Выберите файл" %}</label>
              <input type="file" name="file" class="form-control" id="id_file" required>
            </div>

            <div class="mb-3">
              <label for="id_expiry_date" class="form-label">{% translate "Действителен до (необязательно)" %}</label>
              <input type="date" name="expiry_date" class="form-control" id="id_expiry_date">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Отмена" %}</button>
            <button type="submit" class="btn btn-primary">{% translate "Загрузить" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'clients/js/client_detail.js' %}" defer></script>
{% endblock %}