{# clients/templates/clients/partials/reminder_item.html #}
{% load tz i18n %}

{% comment %}
  Этот шаблон использует фильтр |add с секундами для вычисления будущих временных меток,
  поскольку в Django нет встроенных тегов, таких как {% tomorrow %}.
  - 1 день = 86400 секунд
  - 3 дня = 259200 секунд
{% endcomment %}

{% now "U" as now_timestamp %}
{% with three_days_from_now_ts=now_timestamp|add:259200 %}
{% with display_client=show_client|default:True display_email=show_email|default:True %}

  {% comment %}
    Мы сравниваем временную метку даты выполнения напоминания с текущей временной меткой
    и временной меткой через три дня, чтобы определить его статус.
  {% endcomment %}
  {% with due_date_ts=reminder.due_date|date:"U" %}

    <div class="list-group-item list-group-item-action
        {% if due_date_ts < now_timestamp %}list-group-item-danger{% endif %}
        {% if due_date_ts >= now_timestamp and due_date_ts < three_days_from_now_ts %}list-group-item-warning{% endif %}
        mb-2 border rounded">

      <div class="d-flex w-100 justify-content-between">
        <h5 class="mb-1">
          <i class="fas {{ icon|default:'fa-bell' }} me-2"></i>
          {{ reminder.title }}
        </h5>
        <small class="d-flex align-items-center gap-2">
          <span aria-hidden="true">
            {% if due_date_ts < now_timestamp %}
              <i class="fas fa-circle text-danger"></i>
            {% elif due_date_ts < three_days_from_now_ts %}
              <i class="fas fa-circle text-warning"></i>
            {% else %}
              <i class="fas fa-circle text-success"></i>
            {% endif %}
          </span>
          <strong>{% blocktrans with due=reminder.due_date|date:"d.m.Y" %}К дата: {{ due }}{% endblocktrans %}</strong>
          {% if due_date_ts < now_timestamp %}
            <span class="badge bg-danger ms-2">{% translate "Просрочено" %}</span>
          {% elif due_date_ts < three_days_from_now_ts %}
            <span class="badge bg-warning text-dark ms-2">{% translate "Срочно" %}</span>
          {% endif %}
        </small>
      </div>

      {% if display_client %}
        {% if reminder.client %}
          <p class="mb-1">
            <strong>{% translate "Клиент:" %}</strong>
            <a href="{% url 'clients:client_detail' reminder.client.id %}">{{ reminder.client }}</a>
          </p>
        {% else %}
          <p class="mb-1 text-danger">
            <strong>{% translate "Клиент:" %}</strong> {% translate "(не указан)" %}
          </p>
        {% endif %}
      {% endif %}

      {% if reminder.notes %}
        <p class="mb-2 text-muted">
          <small>{{ reminder.notes|linebreaksbr }}</small>
        </p>
      {% endif %}

      {% if reminder.id %}
        <div class="d-flex justify-content-end flex-wrap gap-2">
          {% if display_email and reminder.reminder_type == 'document' and reminder.document and reminder.document.expiry_date %}
            <form action="{% url 'clients:reminder_action' reminder.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="send_email">
              <input type="hidden" name="next" value="{% if reminder.reminder_type == 'document' and reminder.client %}{{ request.get_full_path }}#heading-{{ reminder.client.id }}{% else %}{{ request.get_full_path }}{% endif %}">
              <button type="submit" class="btn btn-sm btn-primary">
                <i class="fas fa-envelope"></i> {% translate "Отправить email" %}
              </button>
            </form>
          {% endif %}
          <form action="{% url 'clients:reminder_action' reminder.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="deactivate">
              <input type="hidden" name="next" value="{% if reminder.reminder_type == 'document' and reminder.client %}{{ request.get_full_path }}#heading-{{ reminder.client.id }}{% else %}{{ request.get_full_path }}{% endif %}">
              <button type="submit" class="btn btn-sm btn-success">
                  <i class="fas fa-check"></i> {% translate "Выполнено" %}
              </button>
          </form>
          <form action="{% url 'clients:reminder_action' reminder.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="next" value="{% if reminder.reminder_type == 'document' and reminder.client %}{{ request.get_full_path }}#heading-{{ reminder.client.id }}{% else %}{{ request.get_full_path }}{% endif %}">
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('{% translate "Вы уверены, что хотите безвозвратно удалить это напоминание?" %}');">
                  <i class="fas fa-trash"></i> {% translate "Удалить" %}
              </button>
          </form>
        </div>
      {% endif %}
    </div>

  {% endwith %}
{% endwith %}
{% endwith %}
