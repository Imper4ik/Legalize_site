{% extends "base.html" %}
{% load i18n static %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'clients/css/clients_list.css' %}">
{% endblock %}

{% block title %}{% translate "Список клиентов" %}{% endblock %}

{% block page_header %}
<div class="section-header">
  <div>
    <h1 class="h3 mb-1">{% translate "Список клиентов" %}</h1>
    <div class="text-muted">{% translate "Поиск, быстрые заметки и переход в карточку клиента" %}</div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'clients:client_add' %}" class="btn btn-gradient">
      <i class="bi bi-plus-lg me-1"></i>{% translate "Добавить нового клиента" %}
    </a>
  </div>
</div>
{% endblock %}

{% block content %}

<form method="get" class="mb-4">
  <div class="input-group">
    <input type="text"
           name="q"
           class="form-control"
           placeholder="{% translate 'Поиск по имени, почте или номеру дела...' %}"
           value="{{ query }}">
    <button class="btn btn-outline-secondary" type="submit">
      {% translate "Найти" %}
    </button>
  </div>
</form>

<div class="table-container">
  <table class="table table-modern table-hover align-middle mb-0">
    <thead>
      <tr>
        <th>Email</th>
        <th>{% translate "Полное имя" %}</th>
        <th>{% translate "Номер дела" %}</th>
        <th>{% translate "Основание и дата окончания" %}</th>
        <th style="width: 30%;">
          <div class="d-flex justify-content-between align-items-center">
            <span>{% translate "Uwagi / Заметки" %}</span>
            <div class="editor-toolbar d-flex align-items-center">
              <button type="button" class="btn btn-light btn-sm" data-notes-bold title="{% translate 'Жирный' %}">
                <b>B</b>
              </button>
              <i class="bi bi-check-lg text-success ms-1" data-bold-indicator style="display:none;"></i>
            </div>
          </div>
        </th>
        <th>{% translate "Действия" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for client in clients %}
        <tr>
          <td>{{ client.email }}</td>
          <td>{{ client.first_name }} {{ client.last_name }}</td>
          <td><strong>{{ client.case_number|default:"—" }}</strong></td>
          <td>
            {{ client.basis_of_stay|default:"—" }}
            {% if client.legal_basis_end_date %}
              <br>
              <small class="text-muted">
                {% blocktrans with date=client.legal_basis_end_date|date:"d.m.Y" %}до {{ date }}{% endblocktrans %}
              </small>
            {% endif %}
          </td>
          <td>
            <form action="{% url 'clients:update_client_notes' pk=client.pk %}" method="post" class="notes-form">
              {% csrf_token %}
              <input type="hidden" name="notes" class="hidden-notes-input">
              <!-- “None” видно до фокуса; на фокусе очищаем; на blur возвращаем, если пусто -->
              <div class="form-control notes-editor"
                   contenteditable="true"
                   role="textbox"
                   aria-multiline="true"
                   tabindex="0"
                   data-notes-editor>
                {{ client.notes|default:"None"|safe }}
              </div>
              <button class="btn btn-outline-secondary btn-sm mt-2 w-100" type="submit">
                {% translate "Сохранить" %}
              </button>
            </form>
          </td>
          <td>
            <div class="d-grid gap-2">
              <a href="{% url 'clients:client_detail' pk=client.pk %}" class="btn btn-info btn-sm">
                {% translate "Подробнее" %}
              </a>
              <a href="{% url 'clients:client_delete' pk=client.pk %}" class="btn btn-danger btn-sm">
                {% translate "Удалить" %}
              </a>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">
            {% translate "Клиенты не найдены." %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'clients/js/clients_list.js' %}" defer></script>
{% endblock %}
