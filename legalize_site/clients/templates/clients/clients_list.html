{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "Список клиентов" %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12">
    <div class="card border-0 shadow-sm overflow-hidden">
      <div class="card-header bg-transparent border-0 pb-0">
        <div class="d-flex flex-wrap justify-content-between align-items-start align-items-md-center gap-3">
          <div>
            <h1 class="h3 mb-1">{% translate "Список клиентов" %}</h1>
            <p class="text-muted mb-0 small">{% translate "Управляйте карточками клиентов, заметками и напоминаниями в одном месте." %}</p>
          </div>
          <a href="{% url 'clients:client_add' %}" class="btn btn-primary btn-lg d-inline-flex align-items-center gap-2">
            <i class="bi bi-person-plus-fill"></i>
            <span>{% translate "Добавить нового клиента" %}</span>
          </a>
        </div>
      </div>

      <div class="card-body">
        <form method="get" class="row g-2 align-items-center mb-4">
          <div class="col-12 col-lg-8">
            <div class="input-group shadow-sm">
              <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
              <input type="text" name="q" class="form-control border-start-0" placeholder="{% translate 'Поиск по имени, почте или номеру дела...' %}" value="{{ query }}">
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="d-flex flex-wrap flex-lg-nowrap gap-2">
              <button class="btn btn-outline-secondary flex-fill" type="submit">{% translate "Найти" %}</button>
              {% if query %}
                <a href="{% url 'clients:client_list' %}" class="btn btn-light flex-fill">{% translate "Сбросить" %}</a>
              {% endif %}
            </div>
          </div>
        </form>

        <div class="staff-table-wrapper">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">Email</th>
                  <th scope="col">{% translate "Полное имя" %}</th>
                  <th scope="col">{% translate "Номер дела" %}</th>
                  <th scope="col">{% translate "Основание и дата окончания" %}</th>
                  <th scope="col" class="notes-column">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>{% translate "Uwagi / Заметки" %}</span>
                      <div class="editor-toolbar d-flex align-items-center">
                        <button type="button" class="btn btn-light btn-sm format-button" data-format="bold" title="Жирный"><b>B</b></button>
                        <i class="bi bi-check-lg text-success ms-1" id="bold-indicator" style="display: none;"></i>
                      </div>
                    </div>
                  </th>
                  <th scope="col">{% translate "Действия" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for client in clients %}
                  <tr>
                    <td>{{ client.email }}</td>
                    <td>{{ client.first_name }} {{ client.last_name }}</td>
                    <td><strong>{{ client.case_number|default:"—" }}</strong></td>
                    <td>
                      {{ client.basis_of_stay|default:"—" }}
                      {% if client.legal_basis_end_date %}
                        <br>
                        <small class="text-muted">{% blocktranslate with date=client.legal_basis_end_date|date:"d.m.Y" %}до {{ date }}{% endblocktranslate %}</small>
                      {% endif %}
                    </td>
                    <td>
                      <form action="{% url 'clients:update_client_notes' pk=client.pk %}" method="post" class="notes-form">
                        {% csrf_token %}
                        <input type="hidden" name="notes" class="hidden-notes-input">
                        <div class="form-control notes-editor staff-notes-editor" contenteditable="true">{{ client.notes|safe }}</div>
                        <button class="btn btn-outline-secondary btn-sm mt-3 w-100" type="submit">{% translate "Сохранить" %}</button>
                      </form>
                    </td>
                    <td>
                      <div class="d-grid gap-2">
                        <a href="{% url 'clients:client_detail' pk=client.pk %}" class="btn btn-info btn-sm">{% translate "Подробнее" %}</a>
                        <a href="{% url 'clients:client_delete' pk=client.pk %}" class="btn btn-danger btn-sm">{% translate "Удалить" %}</a>
                      </div>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                      <i class="bi bi-people fs-1 d-block mb-2"></i>
                      {% translate "Клиенты не найдены." %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .staff-table-wrapper {
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    .staff-table-wrapper .table-responsive {
      max-height: 70vh;
      overflow-y: auto;
    }

    .staff-table-wrapper .table {
      margin-bottom: 0;
      --bs-table-hover-bg: transparent;
    }

    .staff-table-wrapper .table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(147, 51, 234, 0.12));
      backdrop-filter: blur(6px);
      border-bottom: none;
    }

    .staff-table-wrapper .table tbody tr td,
    .staff-table-wrapper .table thead th {
      vertical-align: middle;
    }

    .staff-table-wrapper .table tbody tr td:nth-child(odd) {
      background-color: rgba(37, 99, 235, 0.05);
    }

    .staff-table-wrapper .table tbody tr td:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.9);
    }

    .staff-table-wrapper .table tbody tr:hover > * {
      background-color: inherit !important;
      box-shadow: none !important;
    }

    .staff-table-wrapper .table tbody tr + tr td {
      border-top: 1px solid rgba(15, 23, 42, 0.08);
    }

    .staff-notes-editor {
      min-height: 3rem;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 0.75rem;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .staff-notes-editor:focus {
      outline: none;
      border-color: rgba(147, 51, 234, 0.45);
      box-shadow: 0 0 0 0.25rem rgba(147, 51, 234, 0.15);
      background-color: rgba(255, 255, 255, 0.98);
    }

    .notes-column {
      min-width: 280px;
    }

    @media (max-width: 991.98px) {
      .notes-column {
        min-width: 240px;
      }

      .staff-table-wrapper .table thead th {
        font-size: 0.85rem;
      }

      .staff-table-wrapper .table tbody td {
        font-size: 0.9rem;
      }
    }
  </style>
{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const formatButton = document.querySelector('.format-button[data-format="bold"]');
      const boldIndicator = document.getElementById('bold-indicator');

      function updateIndicator() {
        if (document.queryCommandState('bold')) {
          boldIndicator.style.display = 'inline-block';
        } else {
          boldIndicator.style.display = 'none';
        }
      }

      formatButton.addEventListener('click', function(e) {
        e.preventDefault();
        document.execCommand('bold', false, null);
        updateIndicator();
      });

      document.querySelectorAll('.notes-editor').forEach(editor => {
        editor.addEventListener('keyup', updateIndicator);
        editor.addEventListener('mouseup', updateIndicator);
      });

      document.querySelectorAll('.notes-form').forEach(form => {
        form.addEventListener('submit', function() {
          const editor = this.querySelector('.notes-editor');
          const hiddenInput = this.querySelector('.hidden-notes-input');
          hiddenInput.value = editor.innerHTML;
        });
      });
    });
  </script>
{% endblock %}