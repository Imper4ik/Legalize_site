{% extends "base.html" %}

{% block title %}Калькулятор выписки из банка{% endblock %}

{% block content %}
  <h1>Калькулятор выписки из банка</h1>
  <p class="text-muted">Рассчитайте полную сумму, необходимую на счету для подачи на карту побыту по учёбе.</p>

  <form method="post" class="mt-4">
    {% csrf_token %}
    <div class="row">
      <div class="col-lg-7">

        <div class="card mb-4">
          <div class="card-header">Часть 1: Расчёт стоимости обучения</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="start_date_input" class="form-label">Дата начала обучения</label>
              <div class="input-group" id="start_date_picker">
                <input type="text" class="form-control" name="start_date" value="{{ form_data.start_date }}" placeholder="дд.мм.гггг" data-input required>
                <a class="btn btn-outline-secondary" title="Выбрать дату" data-toggle>
                  <i class="bi bi-calendar3"></i>
                </a>
              </div>
            </div>
            <div class="mb-3">
              <label for="end_date_input" class="form-label">Дата окончания обучения</label>
              <div class="input-group" id="end_date_picker">
                <input type="text" class="form-control" name="end_date" value="{{ form_data.end_date }}" placeholder="дд.мм.гггг" data-input required>
                <a class="btn btn-outline-secondary" title="Выбрать дату" data-toggle>
                  <i class="bi bi-calendar3"></i>
                </a>
              </div>
            </div>
            <div class="mb-3">
              <label for="monthly_fee" class="form-label">Стоимость обучения в месяц (zł)</label>
              <input type="number" step="0.01" class="form-control" name="monthly_fee" value="{{ form_data.monthly_fee }}" required>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Часть 2: Расчёт расходов на проживание</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="rent" class="form-label">Стоимость аренды жилья в месяц (zł)</label>
              <input type="number" step="0.01" class="form-control" name="rent" value="{{ form_data.rent }}" required>
            </div>
            <div class="mb-3">
              <label for="num_people" class="form-label">Количество человек в семье</label>
              <input type="number" class="form-control" name="num_people" value="{{ form_data.num_people|default:1 }}" required>
            </div>
            <div class="mb-3">
              <label for="months_living" class="form-label">Количество месяцев пребывания</label>
              <input type="number" class="form-control" name="months_living" value="{{ form_data.months_living|default:12 }}" required>
            </div>
            <div class="mb-3">
              <label for="return_ticket" class="form-label">Стоимость обратного билета (zł)</label>
              <input type="number" step="0.01" class="form-control" name="return_ticket" value="{{ form_data.return_ticket|default:2500 }}" required>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary mt-4 w-100">Рассчитать итоговую сумму</button>
      </div>

      <div class="col-lg-5">
        {% if results %}
          <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">Итоговая сумма на счету:</div>
            <div class="card-body bg-success text-white">
                <h3 class="text-center mb-0">{{ results.final_total_required }} zł</h3>
            </div>

            <div class="card-body">
                <h5 class="card-title">Детализация расчёта:</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0">
                        <strong>1. Расходы на проживание:</strong>
                        {% if form_data.num_people == '1' %}
                            <p class="mb-0 small text-muted">((Аренда + Прожиточный минимум) × Кол-во месяцев)</p>
                            <p class="mb-0">
                                (({{ form_data.rent }} + {{ living_cost_single }}) × {{ form_data.months_living }}) = <strong>{{ results.total_living_expenses }} zł</strong>
                            </p>
                        {% else %}
                            <p class="mb-0 small text-muted">((Аренда + (ПМ на 1-го + ПМ на семью × доп. люди)) × Кол-во месяцев)</p>
                            <p class="mb-0">
                                (({{ form_data.rent }} + ({{ living_cost_single }} + {{ living_cost_family }} × {{ form_data.num_people|add:"-1" }})) × {{ form_data.months_living }}) = <strong>{{ results.total_living_expenses }} zł</strong>
                            </p>
                        {% endif %}
                    </li>
                    <li class="list-group-item px-0">
                        <strong>2. Расходы на обучение:</strong>
                        <p class="mb-0 small text-muted">(Кол-во месяцев обучения × Стоимость в месяц)</p>
                         <p class="mb-0">
                            ({{ results.num_months_tuition }} мес. × {{ form_data.monthly_fee }}) = <strong>{{ results.total_tuition }} zł</strong>
                        </p>
                    </li>
                    <li class="list-group-item px-0">
                        <strong>3. Расходы на обратный билет:</strong>
                        <p class="mb-0">
                           <strong>{{ results.return_ticket }} zł</strong>
                        </p>
                    </li>
                </ul>
            </div>
          </div>
        {% else %}
            <div class="alert alert-info">
                Заполните все поля слева и нажмите "Рассчитать", чтобы увидеть результат.
            </div>
        {% endif %}
      </div>
    </div>
  </form>
{% endblock %}

{% block extra_js %}
<script>
  flatpickr("#start_date_picker", {
    wrap: true,
    dateFormat: "d.m.Y",
    allowInput: true,
    clickOpens: false,
  });
  flatpickr("#end_date_picker", {
    wrap: true,
    dateFormat: "d.m.Y",
    allowInput: true,
    clickOpens: false,
  });
</script>
{% endblock %}