{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktranslate with client_name=client.first_name %}–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞: {{ client_name }}{% endblocktranslate %}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <div>
        <a href="{% url 'clients:client_print' pk=client.pk %}" class="btn btn-secondary me-2">{% translate "–ü–µ—á–∞—Ç—å" %}</a>
        <a href="{% url 'clients:client_edit' client.pk %}" class="btn btn-primary">{% translate "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ" %}</a>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-body">
        <p><strong>{% translate "–ù–æ–º–µ—Ä –¥–µ–ª–∞" %}:</strong> <span class="fs-5 text-primary"><strong>{{ client.case_number|default:_("–ù–µ —É–∫–∞–∑–∞–Ω") }}</strong></span></p>
        <p><strong>Email:</strong> {{ client.email }}</p>
        <p><strong>{% translate "–¢–µ–ª–µ—Ñ–æ–Ω" %}:</strong> {{ client.phone }}</p>
        <p><strong>{% translate "–¶–µ–ª—å –ø–æ–¥–∞—á–∏" %}:</strong> {{ client.get_application_purpose_display }}</p>
        <p><strong>{% translate "–û—Å–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è" %}:</strong> {{ client.basis_of_stay|default:_("–ù–µ —É–∫–∞–∑–∞–Ω–æ") }}</p>
        {% if client.legal_basis_end_date %}
            <p><strong>{% translate "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∏—è" %}:</strong> <span class="fw-bold">{{ client.legal_basis_end_date|date:"d.m.Y" }}</span></p>
        {% endif %}
    </div>
  </div>

  <div class="card border-primary mb-4 shadow">
    <div class="card-header bg-primary text-white"><h5 class="mb-0">üîë {% translate "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫–ª–∏–µ–Ω—Ç–∞" %}</h5></div>
    <div class="card-body text-center" id="access-management-container">
        {% include 'clients/partials/access_management_block.html' with client=client %}
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{% translate "–§–∏–Ω–∞–Ω—Å—ã" %}</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">+ {% translate "–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç" %}</button>
  </div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush" id="payment-list-container">
          {% for payment in client.payments.all %}
              <li class="list-group-item" data-payment-id="{{ payment.id }}">
                  {% include 'clients/partials/payment_item.html' with payment=payment %}
              </li>
          {% empty %}
              <li class="list-group-item text-muted" id="no-payments-message">{% translate "–°—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã." %}</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <h2>{% translate "–ß–µ–∫–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" %}</h2>
  <div class="accordion" id="documentAccordion">
      {% include 'clients/partials/document_checklist.html' with document_status_list=document_status_list client=client %}
  </div>

  {% include 'clients/partials/modals.html' %}

{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
        // –ï—Å–ª–∏ —É –≤–∞—à–µ–≥–æ –≥–ª–∞–≤–Ω–æ–≥–æ div –≤ base.html –µ—Å—Ç—å –¥—Ä—É–≥–æ–π id, —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ.
        const mainContent = document.querySelector('main') || document.body;

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö POST-–∑–∞–ø—Ä–æ—Å–æ–≤ ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ —á–µ–∫–ª–∏—Å—Ç–∞ (–Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è) ---
        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç –≤–µ—Å—å –±–ª–æ–∫ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å
        // —Å—á—ë—Ç—á–∏–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã —É –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
        function updateChecklist() {
            const checklistContainer = document.querySelector('#documentAccordion');
            if (!checklistContainer) return;

            // URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ HTML —á–µ–∫–ª–∏—Å—Ç–∞.
            // –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç view –∏ url.
            const url = `{% url 'clients:client_checklist_partial' client.pk %}`;

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    checklistContainer.innerHTML = html;
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —á–µ–∫–ª–∏—Å—Ç–∞:', error));
        }


        // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø AJAX-–§–û–†–ú ---
        mainContent.addEventListener('submit', function(e) {
            const form = e.target;

            // --- –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ---
            if (form.matches('.delete-document-form')) {
                e.preventDefault();
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç?')) {
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: new FormData(form)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç li –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ
                            const listItem = form.closest('.list-group-item');
                            if (listItem) {
                                listItem.remove();
                            }
                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ–∫–ª–∏—Å—Ç, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
                            updateChecklist();
                        } else {
                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    })
                    .catch(err => {
                        console.error('Fetch Error:', err);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
                    });
                }
            }

            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, –¥–æ—Å—Ç—É–ø),
            // –∫–æ–≥–¥–∞ –≤—ã —Ä–µ—à–∏—Ç–µ –µ—ë —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å.
        });
    });
  </script>
{% endblock %}