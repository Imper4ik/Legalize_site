{% extends "base.html" %}

{% block title %}Детали клиента: {{ client.first_name }}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <div>
        <a href="{% url 'clients:client_print' pk=client.pk %}" class="btn btn-secondary me-2">Печать</a>
        <a href="{% url 'clients:client_edit' client.pk %}" class="btn btn-primary">Редактировать данные</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
        <p><strong>Номер дела:</strong> <span class="fs-5 text-primary"><strong>{{ client.case_number|default:"Не указан" }}</strong></span></p>
        <p><strong>Email:</strong> {{ client.email }}</p>
        <p><strong>Телефон:</strong> {{ client.phone }}</p>
        <p><strong>Цель подачи:</strong> {{ client.get_application_purpose_display }}</p>
        <p><strong>Основание пребывания:</strong> {{ client.basis_of_stay|default:"Не указано" }}</p>
        {% if client.legal_basis_end_date %}
            <p><strong>Дата окончания основания:</strong> {{ client.legal_basis_end_date|date:"d.m.Y" }}</p>
        {% endif %}
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Финансы</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
      + Добавить счёт
    </button>
  </div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush">
          {% for payment in client.payments.all %}
              <li class="list-group-item">
                  <div class="d-flex justify-content-between">
                      <div>
                          <span>{{ payment.get_service_description_display }}</span>
                          <button type="button" class="btn btn-link btn-sm p-0 ms-2 edit-payment-btn"
                                  data-bs-toggle="modal" data-bs-target="#editPaymentModal"
                                  data-url="{% url 'clients:edit_payment' payment.id %}"
                                  data-service="{{ payment.service_description }}"
                                  data-total_amount="{{ payment.total_amount }}"
                                  data-amount_paid="{{ payment.amount_paid }}"
                                  data-status="{{ payment.status }}">
                              <i class="bi bi-pencil-square"></i>
                          </button>
                          <form action="{% url 'clients:delete_payment' payment.id %}" method="post" class="d-inline" onsubmit="return confirm('Вы уверены?');">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-link btn-sm p-0 text-danger" title="Удалить платёж">
                                  <i class="bi bi-trash"></i>
                              </button>
                          </form>
                      </div>
                      <span class="badge {% if payment.status == 'paid' %}bg-success{% elif payment.status == 'partial' %}bg-warning{% else %}bg-danger{% endif %}">
                          {{ payment.get_status_display }}
                      </span>
                  </div>
                  <div class="progress mt-1" style="height: 20px;">
                      <div class="progress-bar" role="progressbar" style="width: {% widthratio payment.amount_paid payment.total_amount 100 %}%;"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-1">
                      <small>Оплачено: {{ payment.amount_paid }} zł</small>
                      <small>Всего: {{ payment.total_amount }} zł</small>
                  </div>
              </li>
          {% empty %}
              <li class="list-group-item text-muted">Счета на оплату еще не созданы.</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <h2>Чеклист документов</h2>
  <div class="accordion" id="documentAccordion">
    {% for item in document_status_list %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ item.code }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.code }}">
            {{ item.name }}
            {% if item.is_uploaded %}
              <span class="badge bg-success ms-3">{{ item.documents|length }} шт.</span>
            {% else %}
              <span class="badge bg-danger ms-3">Отсутствует</span>
            {% endif %}
          </button>
        </h2>
        <div id="collapse{{ item.code }}" class="accordion-collapse collapse" data-bs-parent="#documentAccordion">
          <div class="accordion-body">
            {% if item.is_uploaded %}
              <ul class="list-group list-group-flush mb-3">
                {% for doc in item.documents %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <a href="{{ doc.file.url }}" target="_blank">
                        Файл от {{ doc.uploaded_at|date:"d.m.Y H:i" }}
                      </a>
                      {% if doc.verified %}
                          <span class="badge bg-success ms-2">Проверен</span>
                      {% else %}
                          <span class="badge bg-warning text-dark ms-2">Ожидает проверки</span>
                      {% endif %}
                    </div>
                    <div>
                      <form action="{% url 'clients:toggle_document_verification' doc.id %}" method="post" class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-primary me-2">
                              {% if doc.verified %}Снять отметку{% else %}Проверить{% endif %}
                          </button>
                      </form>
                      <a href="{% url 'clients:document_delete' doc.pk %}" class="btn btn-warning btn-sm">Удалить</a>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">Документы этого типа еще не загружены.</p>
            {% endif %}
            <a href="{% url 'clients:add_document' client_id=client.id doc_type=item.code %}" class="btn btn-primary btn-sm">
              + Добавить еще один файл
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-warning">
        Для цели "{{ client.get_application_purpose_display }}" на языке "{{ client.get_language_display }}" чеклист документов не определен.
      </div>
    {% endfor %}
  </div>

  <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPaymentModalLabel">Добавить новый счёт</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="{% url 'clients:add_payment' client.id %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="id_service_description" class="form-label">Услуга</label>
              <select name="service_description" class="form-select" id="id_service_description" required>
                {% for choice_value, choice_label in payment_form.service_description.field.choices %}
                  <option value="{{ choice_value }}">{{ choice_label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="id_total_amount" class="form-label">Общая сумма</label>
              <input type="number" step="0.01" name="total_amount" class="form-control" id="id_total_amount" required>
            </div>
            <div class="mb-3">
              <label for="id_amount_paid" class="form-label">Оплачено</label>
              <input type="number" step="0.01" name="amount_paid" class="form-control" id="id_amount_paid" value="0.00" required>
            </div>
            <div class="mb-3">
              <label for="id_due_date" class="form-label">Дата оплаты (если есть)</label>
              <input type="date" name="due_date" class="form-control" id="id_due_date">
            </div>
            <div class="mb-3">
              <label for="id_status" class="form-label">Статус</label>
              <select name="status" class="form-select" id="id_status" required>
                {% for choice_value, choice_label in payment_form.status.field.choices %}
                  <option value="{{ choice_value }}">{{ choice_label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить счёт</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPaymentModalLabel">Редактировать счёт</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editPaymentForm" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="edit_id_service_description" class="form-label">Услуга</label>
              <select name="service_description" class="form-select" id="edit_id_service_description" required>
                {% for choice_value, choice_label in payment_form.service_description.field.choices %}
                  <option value="{{ choice_value }}">{{ choice_label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="edit_id_total_amount" class="form-label">Общая сумма</label>
              <input type="number" step="0.01" name="total_amount" class="form-control" id="edit_id_total_amount" required>
            </div>
            <div class="mb-3">
              <label for="edit_id_amount_paid" class="form-label">Оплачено</label>
              <input type="number" step="0.01" name="amount_paid" class="form-control" id="edit_id_amount_paid" required>
            </div>
            <div class="mb-3">
              <label for="edit_id_due_date" class="form-label">Дата оплаты (если есть)</label>
              <input type="date" name="due_date" class="form-control" id="edit_id_due_date">
            </div>
            <div class="mb-3">
              <label for="edit_id_status" class="form-label">Статус</label>
              <select name="status" class="form-select" id="edit_id_status" required>
                {% for choice_value, choice_label in payment_form.status.field.choices %}
                  <option value="{{ choice_value }}">{{ choice_label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить изменения</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Логика для авто-заполнения цены ---
      const serviceSelect = document.getElementById('id_service_description');
      const totalAmountInput = document.getElementById('id_total_amount');
      // Данные о ценах передаются из views.py
      const servicePrices = JSON.parse('{{ service_prices_json|escapejs|default:"{}" }}');

      if (serviceSelect) {
          serviceSelect.addEventListener('change', function() {
            const selectedService = this.value;
            if (selectedService && servicePrices[selectedService]) {
              totalAmountInput.value = servicePrices[selectedService];
            } else {
              totalAmountInput.value = '';
            }
          });
      }

      // --- Логика для модального окна редактирования ---
      const editPaymentModal = document.getElementById('editPaymentModal');
      if (editPaymentModal) {
          editPaymentModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const url = button.getAttribute('data-url');
            const service = button.getAttribute('data-service');
            const totalAmount = button.getAttribute('data-total_amount');
            const amountPaid = button.getAttribute('data-amount_paid');
            const status = button.getAttribute('data-status');

            const form = editPaymentModal.querySelector('#editPaymentForm');
            form.action = url;

            editPaymentModal.querySelector('#edit_id_service_description').value = service;
            editPaymentModal.querySelector('#edit_id_total_amount').value = totalAmount;
            editPaymentModal.querySelector('#edit_id_amount_paid').value = amountPaid;
            editPaymentModal.querySelector('#edit_id_status').value = status;
          });
      }
    });
  </script>
{% endblock %}