{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktranslate with client_name=client.first_name %}–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞: {{ client_name }}{% endblocktranslate %}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <div>
        <a href="{% url 'clients:client_print' pk=client.pk %}" class="btn btn-secondary me-2">{% translate "–ü–µ—á–∞—Ç—å" %}</a>
        <a href="{% url 'clients:client_edit' client.pk %}" class="btn btn-primary">{% translate "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ" %}</a>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-body">
        <p><strong>{% translate "–ù–æ–º–µ—Ä –¥–µ–ª–∞" %}:</strong> <span class="fs-5 text-primary"><strong>{{ client.case_number|default:_("–ù–µ —É–∫–∞–∑–∞–Ω") }}</strong></span></p>
        <p><strong>Email:</strong> {{ client.email }}</p>
        <p><strong>{% translate "–¢–µ–ª–µ—Ñ–æ–Ω" %}:</strong> {{ client.phone }}</p>
        <p><strong>{% translate "–¶–µ–ª—å –ø–æ–¥–∞—á–∏" %}:</strong> {{ client.get_application_purpose_display }}</p>
        <p><strong>{% translate "–û—Å–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è" %}:</strong> {{ client.basis_of_stay|default:_("–ù–µ —É–∫–∞–∑–∞–Ω–æ") }}</p>
        {% if client.legal_basis_end_date %}
            <p><strong>{% translate "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∏—è" %}:</strong> <span class="fw-bold">{{ client.legal_basis_end_date|date:"d.m.Y" }}</span></p>
        {% endif %}
    </div>
  </div>

  <div class="card border-primary mb-4 shadow">
    <div class="card-header bg-primary text-white"><h5 class="mb-0">üîë {% translate "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫–ª–∏–µ–Ω—Ç–∞" %}</h5></div>
    <div class="card-body text-center" id="access-management-container">
        {% include 'clients/partials/access_management_block.html' with client=client %}
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{% translate "–§–∏–Ω–∞–Ω—Å—ã" %}</h4>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">+ {% translate "–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç" %}</button>
  </div>
  <div class="card mb-4">
      <ul class="list-group list-group-flush" id="payment-list-container">
          {% for payment in client.payments.all %}
              <li class="list-group-item" data-payment-id="{{ payment.id }}">
                  {% include 'clients/partials/payment_item.html' with payment=payment %}
              </li>
          {% empty %}
              <li class="list-group-item text-muted" id="no-payments-message">{% translate "–°—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã." %}</li>
          {% endfor %}
      </ul>
  </div>

  <hr>

  <h2>{% translate "–ß–µ–∫–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" %}</h2>
  <div class="accordion" id="documentAccordion">
      {% include 'clients/partials/document_checklist.html' with document_status_list=document_status_list client=client %}
  </div>

  {% include 'clients/partials/modals.html' %}

{% endblock %}


{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- –û–ë–©–ò–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const mainContent = document.body;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const documentAccordion = document.getElementById('documentAccordion');
        const paymentListContainer = document.getElementById('payment-list-container');
        const addPaymentModalEl = document.getElementById('addPaymentModal');
        const editPaymentModalEl = document.getElementById('editPaymentModal');
        const addPaymentModal = new bootstrap.Modal(addPaymentModalEl);
        const editPaymentModal = new bootstrap.Modal(editPaymentModalEl);

        // --- "–ñ–ò–í–ê–Ø" –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ß–ï–ö–õ–ò–°–¢–ê ---
        function updateChecklist() {
            fetch("{% url 'clients:client_status_api' client.pk %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && documentAccordion) {
                        documentAccordion.innerHTML = data.checklist_html;
                    }
                });
        }

        // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø AJAX-–§–û–†–ú ---
        mainContent.addEventListener('submit', function(e) {
            const form = e.target;

            // --- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ ---
            if (form.matches('#grant-access-form')) { e.preventDefault(); /* ... */ }
            // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
            if (form.matches('.toggle-verification-form')) { e.preventDefault(); /* ... */ }
            // --- –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ---
            if (form.matches('.delete-document-form')) { e.preventDefault(); /* ... */ }
        });

        // --- –§–û–ù–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–ñ–î–´–ï 15 –°–ï–ö–£–ù–î ---
        setInterval(updateChecklist, 15000);

        // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–õ–ê–¢–ï–ñ–ï–ô –ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù (–ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø) ---

        // 1. –ê–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
        const serviceSelect = addPaymentModalEl.querySelector('#id_service_description');
        const totalAmountInput = addPaymentModalEl.querySelector('#id_total_amount');
        const servicePrices = JSON.parse('{{ service_prices_json|escapejs|default:"{}" }}');

        serviceSelect.addEventListener('change', function() {
            const selectedService = this.value;
            totalAmountInput.value = servicePrices[selectedService] || '';
        });

        // 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        editPaymentModalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = editPaymentModalEl.querySelector('form');
            form.action = button.dataset.url;
            editPaymentModalEl.querySelector('#edit_id_service_description').value = button.dataset.service;
            editPaymentModalEl.querySelector('#edit_id_total_amount').value = button.dataset.total_amount;
            editPaymentModalEl.querySelector('#edit_id_amount_paid').value = button.dataset.amount_paid;
            editPaymentModalEl.querySelector('#edit_id_status').value = button.dataset.status;
        });

        // 3. AJAX-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
        function handlePaymentFormSubmit(form, modalInstance) {
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...`;

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json().then(data => ({ ok: response.ok, body: data })))
            .then(({ ok, body }) => {
                if (ok) {
                    const paymentId = body.payment_id;
                    const newItemHTML = body.html;
                    if (form.id === 'editPaymentForm') {
                        const oldItem = paymentListContainer.querySelector(`[data-payment-id="${paymentId}"]`);
                        if (oldItem) oldItem.innerHTML = newItemHTML;
                    } else {
                        const noPaymentsMessage = document.getElementById('no-payments-message');
                        if (noPaymentsMessage) noPaymentsMessage.remove();
                        const newItem = document.createElement('li');
                        newItem.classList.add('list-group-item');
                        newItem.dataset.paymentId = paymentId;
                        newItem.innerHTML = newItemHTML;
                        paymentListContainer.appendChild(newItem);
                    }
                    modalInstance.hide();
                    form.reset();
                } else {
                    const errorMsg = Object.values(body.errors).map(e => e.join(' ')).join('\n');
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è:\n\n' + errorMsg);
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText.includes('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') ? originalButtonText : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            });
        }

        const addPaymentForm = addPaymentModalEl.querySelector('form');
        addPaymentForm.addEventListener('submit', function(e) { e.preventDefault(); handlePaymentFormSubmit(this, addPaymentModal); });

        const editPaymentForm = editPaymentModalEl.querySelector('form');
        editPaymentForm.addEventListener('submit', function(e) { e.preventDefault(); handlePaymentFormSubmit(this, editPaymentModal); });

        // 4. AJAX-—É–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
        paymentListContainer.addEventListener('submit', function(e) {
            if (e.target.matches('.delete-payment-form')) {
                e.preventDefault();
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                    const form = e.target;
                    fetch(form.action, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            form.closest('.list-group-item').remove();
                        } else {
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂.');
                        }
                    });
                }
            }
        });
    });
  </script>
{% endblock %}